<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lecture 4: Multinomial Logistic Regression for Expected Points – Special Topics: Sports Analytics 36-460/660</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-a6a01229d4f8bdf1dc707ca4bfce0e81.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">
      Special Topics: Sports Analytics 36-460/660
      </li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Special Topics: Sports Analytics 36-460/660</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ryurko/cmu-sportsanalytics-spring25" title="GitHub" class="quarto-navigation-tool px-1" aria-label="GitHub"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lectures</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../demos.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Demos</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#fitting-a-multinomial-logistic-regression-model" id="toc-fitting-a-multinomial-logistic-regression-model" class="nav-link" data-scroll-target="#fitting-a-multinomial-logistic-regression-model">Fitting a multinomial logistic regression model</a></li>
  <li><a href="#cross-validation-calibration" id="toc-cross-validation-calibration" class="nav-link" data-scroll-target="#cross-validation-calibration">Cross-validation calibration</a></li>
  <li><a href="#recap" id="toc-recap" class="nav-link" data-scroll-target="#recap">Recap</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lecture 4: Multinomial Logistic Regression for Expected Points</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The goal of this demo is to introduce how to fit and evaluate a <strong>multinomial logistic regression</strong> model in the context of modeling the next scoring event in American football. For this demo, we’ll use an example dataset of NFL play-by-play data from 2013 to 2023. This is initialized with a column including the next score in the half for each play (you can find the script on Canvas, which creates the dataset using <a href="https://nflreadr.nflverse.com/"><code>nflreadr</code></a>).</p>
<p>The following code chunk reads in the relevant NFL play-by-play dataset (assuming it is in the correct directory) and performs some initial pre-processing relevant for the expected points model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>nfl_ep_model_data <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data/model_nfl_pbp_data.rds"</span>))</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>nfl_ep_model_data <span class="ot">&lt;-</span> nfl_ep_model_data <span class="sc">|&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make the No_Score level the reference level:</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Next_Score_Half =</span> <span class="fu">fct_relevel</span>(Next_Score_Half, <span class="st">"No_Score"</span>),</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>         <span class="co"># log transform of yards to go and indicator for two minute warning:</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">log_ydstogo =</span> <span class="fu">log</span>(ydstogo),</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Changing down into a factor variable: </span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">down =</span> <span class="fu">factor</span>(down))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>nfl_ep_model_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 422,904 × 21
   game_id     Next_Score_Half Drive_Score_Half play_type game_seconds_remaining
   &lt;chr&gt;       &lt;fct&gt;                      &lt;dbl&gt; &lt;chr&gt;                      &lt;dbl&gt;
 1 2013_01_AR… Opp_Touchdown                  4 pass                        3593
 2 2013_01_AR… Opp_Touchdown                  4 run                         3572
 3 2013_01_AR… Opp_Touchdown                  4 pass                        3536
 4 2013_01_AR… Opp_Touchdown                  4 no_play                     3507
 5 2013_01_AR… Opp_Touchdown                  4 run                         3476
 6 2013_01_AR… Opp_Touchdown                  4 no_play                     3446
 7 2013_01_AR… Opp_Touchdown                  4 pass                        3428
 8 2013_01_AR… Opp_Touchdown                  4 pass                        3424
 9 2013_01_AR… Opp_Touchdown                  4 punt                        3397
10 2013_01_AR… Touchdown                      4 run                         3386
# ℹ 422,894 more rows
# ℹ 16 more variables: half_seconds_remaining &lt;dbl&gt;, yardline_100 &lt;dbl&gt;,
#   posteam &lt;chr&gt;, defteam &lt;chr&gt;, home_team &lt;chr&gt;, ydstogo &lt;dbl&gt;, season &lt;int&gt;,
#   qtr &lt;dbl&gt;, down &lt;fct&gt;, week &lt;int&gt;, drive &lt;dbl&gt;, score_differential &lt;dbl&gt;,
#   posteam_timeouts_remaining &lt;dbl&gt;, defteam_timeouts_remaining &lt;dbl&gt;,
#   desc &lt;chr&gt;, log_ydstogo &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
<section id="fitting-a-multinomial-logistic-regression-model" class="level2">
<h2 class="anchored" data-anchor-id="fitting-a-multinomial-logistic-regression-model">Fitting a multinomial logistic regression model</h2>
<p>In order to fit a multinomial logistic regression model in <code>R</code>, the easiest way is to use the <code>nnet</code> package with the <code>multinom</code> function. The following code chunk fits this model to the full dataset with the <code>Next_Score_Half</code> variable as the response with the context variables as the predictors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nnet)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>init_ep_model <span class="ot">&lt;-</span> <span class="fu">multinom</span>(Next_Score_Half <span class="sc">~</span> half_seconds_remaining <span class="sc">+</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                            yardline_100 <span class="sc">+</span> down <span class="sc">+</span> log_ydstogo <span class="sc">+</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                            log_ydstogo <span class="sc">*</span> down <span class="sc">+</span> yardline_100 <span class="sc">*</span> down, </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">data =</span> nfl_ep_model_data, <span class="at">maxit =</span> <span class="dv">300</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># weights:  98 (78 variable)
initial  value 822933.185674 
iter  10 value 646448.661731
iter  20 value 628562.786640
iter  30 value 616585.530613
iter  40 value 600078.459583
iter  50 value 597249.917485
iter  60 value 568326.053579
iter  70 value 561806.646221
iter  80 value 556313.688644
iter  90 value 555528.854290
iter 100 value 555518.276158
final  value 555518.120956 
converged</code></pre>
</div>
</div>
<p>Note the use of <code>maxit = 300</code> is to provide a sufficient number of steps for model fitting. You’ll notice the printing of iteration steps here because this package is actually the simplest package used for fitting neural networks in <code>R</code>.</p>
<p>Notice what happens when we use the <code>summary()</code> function on this model (it takes some time to run):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(init_ep_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
multinom(formula = Next_Score_Half ~ half_seconds_remaining + 
    yardline_100 + down + log_ydstogo + log_ydstogo * down + 
    yardline_100 * down, data = nfl_ep_model_data, maxit = 300)

Coefficients:
               (Intercept) half_seconds_remaining yardline_100      down2
Field_Goal      -0.2607051            0.004116958 -0.034840581  0.7076165
Opp_Field_Goal  -3.0189007            0.004293194  0.001137907  0.1443799
Opp_Safety      -8.9905777            0.004245522  0.058165564 -1.0759002
Opp_Touchdown   -2.8386923            0.004508825  0.001923287  0.0914707
Safety          -4.1544215            0.004459871 -0.019844872 -0.8222278
Touchdown        2.1128586            0.004298760 -0.036028100 -1.0277706
                    down3      down4 log_ydstogo down2:log_ydstogo
Field_Goal      0.8926587  1.2557561   0.3805016     -0.2836294318
Opp_Field_Goal  0.2142137  0.3490739   0.1395655     -0.0468113016
Opp_Safety     -0.4023122  0.8780304  -0.6304597      0.7793959964
Opp_Touchdown   0.1912419  0.3611854   0.1176799     -0.0008362159
Safety         -0.7113207 -0.5755544  -0.3702644      0.4053892714
Touchdown      -1.4807308 -2.8058121  -0.5186325      0.3515486857
               down3:log_ydstogo down4:log_ydstogo yardline_100:down2
Field_Goal          -0.276146057        -0.1963895      -0.0014910525
Opp_Field_Goal      -0.053572298        -0.1586719       0.0015471520
Opp_Safety           0.753610712         0.7305257      -0.0066148761
Opp_Touchdown       -0.008979889        -0.1477311       0.0008414841
Safety               0.331151454         0.3681949      -0.0006310041
Touchdown            0.307635794         0.2487536       0.0002840841
               yardline_100:down3 yardline_100:down4
Field_Goal           -0.006491710       -0.022099391
Opp_Field_Goal        0.003617006        0.007415363
Opp_Safety           -0.012361132       -0.028266233
Opp_Touchdown         0.002475162        0.006787692
Safety                0.001022146       -0.001257291
Touchdown             0.005196036        0.020872169

Std. Errors:
                (Intercept) half_seconds_remaining yardline_100        down2
Field_Goal     9.973877e-03           2.056382e-05 0.0003265603 9.222868e-03
Opp_Field_Goal 1.301499e-02           2.164403e-05 0.0003570708 3.525795e-03
Opp_Safety     3.608208e-05           6.056503e-05 0.0009598729 1.676993e-05
Opp_Touchdown  1.249336e-02           2.114300e-05 0.0003484688 4.994918e-03
Safety         2.031640e-04           4.981585e-05 0.0010522061 1.154787e-04
Touchdown      9.156701e-03           2.042802e-05 0.0003097515 1.026284e-02
                      down3        down4  log_ydstogo down2:log_ydstogo
Field_Goal     9.165213e-03 4.368126e-03 0.0076911593      0.0084179580
Opp_Field_Goal 3.705261e-03 2.529465e-03 0.0070133975      0.0086822558
Opp_Safety     1.585732e-05 1.948469e-05 0.0002905214      0.0001058366
Opp_Touchdown  4.972851e-03 3.315516e-03 0.0077647303      0.0088275451
Safety         7.438725e-05 5.127217e-05 0.0007459947      0.0003197118
Touchdown      1.038676e-02 2.457417e-03 0.0071809004      0.0078822666
               down3:log_ydstogo down4:log_ydstogo yardline_100:down2
Field_Goal          0.0085571300      0.0099954257       0.0004123602
Opp_Field_Goal      0.0086850330      0.0095492903       0.0003746628
Opp_Safety          0.0001036511      0.0000755188       0.0009717132
Opp_Touchdown       0.0090569632      0.0103499484       0.0003861318
Safety              0.0002244464      0.0001505608       0.0011547005
Touchdown           0.0080808936      0.0105894677       0.0003887755
               yardline_100:down3 yardline_100:down4
Field_Goal           0.0004477493       0.0005864862
Opp_Field_Goal       0.0003898272       0.0004537012
Opp_Safety           0.0011035945       0.0013637166
Opp_Touchdown        0.0004097842       0.0004720251
Safety               0.0013038376       0.0015717666
Touchdown            0.0004227704       0.0004995965

Residual Deviance: 1111036 
AIC: 1111192 </code></pre>
</div>
</div>
<p>You see the usual type of output (coefficients, standard errors, deviance, AIC), but we see coefficient estimates for each next score outcome (except for the reference level <code>No_Score</code>).</p>
<p>Alternatively, it can be helpful to visualize the implied relationships between the various features and the outcome probabilities using visualization techniques. In order to do this, we first need to get the fitted probabilities for each scoring event. For a <code>nnet</code> multinomial logistic regression model, we can use the <code>predict()</code> function with <code>type = "probs"</code> as an input to return the matrix of probabilities for each event:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>next_score_probs <span class="ot">&lt;-</span> <span class="fu">predict</span>(init_ep_model, </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">newdata =</span> nfl_ep_model_data, <span class="at">type =</span> <span class="st">"probs"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>next_score_probs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 422,904 × 7
   No_Score Field_Goal Opp_Field_Goal Opp_Safety Opp_Touchdown  Safety Touchdown
      &lt;dbl&gt;      &lt;dbl&gt;          &lt;dbl&gt;      &lt;dbl&gt;         &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;
 1 0.000970      0.204         0.157    0.00476          0.279 0.00427     0.350
 2 0.000864      0.236         0.126    0.00217          0.222 0.00422     0.408
 3 0.000912      0.234         0.119    0.00167          0.204 0.00445     0.437
 4 0.000876      0.269         0.0957   0.000879         0.164 0.00398     0.465
 5 0.00131       0.324         0.139    0.00133          0.236 0.00328     0.295
 6 0.00132       0.274         0.131    0.00188          0.227 0.00460     0.361
 7 0.00158       0.261         0.151    0.00282          0.262 0.00463     0.317
 8 0.00164       0.238         0.184    0.00363          0.320 0.00471     0.247
 9 0.00173       0.265         0.168    0.00226          0.285 0.00669     0.271
10 0.00255       0.199         0.170    0.00655          0.291 0.00411     0.327
# ℹ 422,894 more rows</code></pre>
</div>
</div>
<p>The following code chunk joins these probabilities to the original dataset, and creates a visual that displays a smooth regression (we’ll cover this later) of the model’s probabilities as a function of certain inputs. <em>Note: these visuals do not represent the exact relationship, but rather just a summary of the relationships.</em> <a href="https://github.com/ryurko/nflscrapR-models/blob/master/R/nflWAR_paper_figures_code/nflWAR_ep_figures.R">This code</a> was used to generate the figures in <a href="https://arxiv.org/abs/1802.00998">my paper</a>.</p>
<div class="cell" data-fig.asp="0.25">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the facetted version for each events probability based on down:</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>nfl_ep_model_data <span class="sc">|&gt;</span> </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Join the probs:</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(next_score_probs) <span class="sc">|&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Only grab a subset of columns</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(yardline_100, down, No_Score<span class="sc">:</span>Touchdown) <span class="sc">|&gt;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(No_Score<span class="sc">:</span>Touchdown,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>               <span class="co"># Name of the column for the outcomes</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"next_score_type"</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>               <span class="co"># Name of the column for the predicted probabilities</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"pred_prob"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a score value column to use for the color legend</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">event_value =</span> <span class="fu">case_when</span>(</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>                         next_score_type <span class="sc">==</span> <span class="st">"No_Score"</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>                         next_score_type <span class="sc">==</span> <span class="st">"Touchdown"</span> <span class="sc">~</span> <span class="dv">7</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>                         next_score_type <span class="sc">==</span> <span class="st">"Field_Goal"</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>                         next_score_type <span class="sc">==</span> <span class="st">"Safety"</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>                         next_score_type <span class="sc">==</span> <span class="st">"Opp_Field_Goal"</span> <span class="sc">~</span> <span class="sc">-</span><span class="dv">3</span>,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>                         next_score_type <span class="sc">==</span> <span class="st">"Opp_Safety"</span> <span class="sc">~</span> <span class="sc">-</span><span class="dv">2</span>,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>                         <span class="cn">TRUE</span> <span class="sc">~</span> <span class="sc">-</span><span class="dv">7</span>),</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Label for down</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">down_label =</span> <span class="fu">case_when</span>(</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>                        down <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"1st down"</span>,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>                        down <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"2nd down"</span>,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>                        down <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"3rd down"</span>,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>                        <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"4th down"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> yardline_100, <span class="at">y =</span> pred_prob, <span class="at">color =</span> event_value,</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>             <span class="at">group =</span> next_score_type)) <span class="sc">+</span> </span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>down_label, <span class="at">ncol =</span> <span class="dv">4</span>) <span class="sc">+</span> </span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Yards from opponent's end zone"</span>, <span class="at">y =</span> <span class="st">"Predicted probability"</span>) <span class="sc">+</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient2</span>(<span class="at">low =</span> <span class="st">"darkorange4"</span>, <span class="at">mid =</span> <span class="st">"gray"</span>,</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>                        <span class="at">high =</span> <span class="st">"darkslateblue"</span>, </span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>                        <span class="at">breaks =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">7</span>, <span class="sc">-</span><span class="dv">3</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">7</span>),</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels=</span><span class="fu">c</span>(<span class="st">" -Touchdown (-7) "</span>, <span class="st">" -Field Goal (-3) "</span>,</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">" -Safety (-2) "</span>, <span class="st">" No Score (0) "</span>,</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">" Safety (2) "</span>, <span class="st">" Field Goal (3) "</span>, </span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">" Touchdown (7) "</span>),</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>                        <span class="at">guide =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>, <span class="at">ncol =</span> <span class="dv">7</span>,</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">reverse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">5</span>))) <span class="sc">+</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>),</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>),</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-multinom-logit_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="1536"></p>
</figure>
</div>
</div>
</div>
<p>We can also create a figure that summarizes the relationships between different features with the actual variable of interest: <strong>expected points</strong>. The first step is to compute the expected points, which we can do using a simple line of code that weights each probability with a point value for the outcome:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>next_score_probs <span class="ot">&lt;-</span> next_score_probs <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ep =</span> Touchdown <span class="sc">*</span> <span class="dv">7</span> <span class="sc">+</span> Field_Goal <span class="sc">*</span> <span class="dv">3</span> <span class="sc">+</span> Safety <span class="sc">*</span> <span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>           Opp_Touchdown <span class="sc">*</span> <span class="sc">-</span><span class="dv">7</span> <span class="sc">+</span> Opp_Field_Goal <span class="sc">*</span> <span class="sc">-</span><span class="dv">3</span> <span class="sc">+</span> Opp_Safety <span class="sc">*</span> <span class="sc">-</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then use a similar approach as before, including historical models, to display the implied relationships:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected points relationships, for the historical models:</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># First the Carter model:</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>carter_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="st">"yardline_100"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">95</span>, <span class="dv">85</span>, <span class="dv">75</span>, <span class="dv">65</span>, <span class="dv">55</span>, <span class="dv">45</span>, <span class="dv">35</span>, <span class="dv">25</span>, <span class="dv">15</span>, <span class="dv">5</span>),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"ep"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.245</span>, <span class="sc">-</span>.<span class="dv">637</span>, .<span class="dv">236</span>, .<span class="dv">923</span>, <span class="fl">1.538</span>, <span class="fl">2.392</span>, </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                               <span class="fl">3.167</span>, <span class="fl">3.681</span>, <span class="fl">4.572</span>, <span class="fl">6.041</span>)) <span class="sc">|&gt;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Carter"</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co"># and Hidden Game of Football model:</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>hgf_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="st">"yardline_100"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">75</span>, <span class="dv">50</span>, <span class="dv">25</span>, <span class="dv">0</span>),</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"ep"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>)) <span class="sc">|&gt;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Hidden Game of Football"</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Display our model's results by down and then compare to the historical</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># models from Carter and the Hidden Game of Football:</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>nfl_ep_model_data <span class="sc">|&gt;</span> </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(next_score_probs) <span class="sc">|&gt;</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Only grab a subset of columns</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(yardline_100, down, ep) <span class="sc">|&gt;</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> yardline_100, <span class="at">y =</span> ep,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="fu">as.factor</span>(down))) <span class="sc">+</span> </span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Yards from opponent's end zone"</span>,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Expected points value"</span>,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Model"</span>) <span class="sc">+</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">6</span>),<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">2</span>)) <span class="sc">+</span> </span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">bind_rows</span>(carter_data, hgf_data),</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> yardline_100, <span class="at">y =</span> ep, <span class="at">color =</span> model),</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="dv">2</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">bind_rows</span>(carter_data, hgf_data),</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> yardline_100, <span class="at">y =</span> ep, <span class="at">color =</span> model),</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="dv">5</span>, <span class="at">to =</span> <span class="dv">95</span>, <span class="at">by =</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#0000FF"</span>,</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"#5537AA"</span>,</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"#AA6E55"</span>,</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"#FFA500"</span>,</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"seagreen4"</span>,</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"darkred"</span>),</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Multilogit - 1st down"</span>,</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Multilogit - 2nd down"</span>,</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Multilogit - 3rd down"</span>,</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Multilogit - 4th down"</span>,</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Carter"</span>,</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Hidden Game of Football"</span>)) <span class="sc">+</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>),</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 2329 rows containing non-finite outside the scale range
(`stat_smooth()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values or values outside the scale range
(`geom_line()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values or values outside the scale range
(`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-multinom-logit_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cross-validation-calibration" class="level2">
<h2 class="anchored" data-anchor-id="cross-validation-calibration">Cross-validation calibration</h2>
<p>Since our goal relies on using the model’s probability estimates, we can evaluate the model similar to the expected goals model: via out-of-sample calibration. The notable difference is that we need to assess how well the model is calibrated <strong>for each scoring event</strong>. The following code generates the <strong>leave-one-year-out cross-validation</strong> predictions for each play in the dataset (note that the model fitting steps are printed for each season fold):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>init_loso_cv_preds <span class="ot">&lt;-</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dfr</span>(<span class="fu">unique</span>(nfl_ep_model_data<span class="sc">$</span>season), </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>          <span class="cf">function</span>(x) {</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Separate test and training data:</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>            test_data <span class="ot">&lt;-</span> nfl_ep_model_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(season <span class="sc">==</span> x)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>            train_data <span class="ot">&lt;-</span> nfl_ep_model_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(season <span class="sc">!=</span> x)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fit multinomial logistic regression model:</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>            ep_model <span class="ot">&lt;-</span> </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>              <span class="fu">multinom</span>(Next_Score_Half <span class="sc">~</span> half_seconds_remaining <span class="sc">+</span> yardline_100 <span class="sc">+</span> down <span class="sc">+</span> </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>                         log_ydstogo <span class="sc">+</span> log_ydstogo <span class="sc">*</span> down <span class="sc">+</span> yardline_100 <span class="sc">*</span> down, </span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> train_data, <span class="at">maxit =</span> <span class="dv">300</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Return dataset of class probabilities:</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">predict</span>(ep_model, <span class="at">newdata =</span> test_data, <span class="at">type =</span> <span class="st">"probs"</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>              <span class="fu">as_tibble</span>() <span class="sc">|&gt;</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>              <span class="fu">mutate</span>(<span class="at">Next_Score_Half =</span> test_data<span class="sc">$</span>Next_Score_Half,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">season =</span> x)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>              })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># weights:  98 (78 variable)
initial  value 747749.055246 
iter  10 value 581440.350658
iter  20 value 566007.216610
iter  30 value 553092.654185
iter  40 value 538119.354133
iter  50 value 536424.391744
iter  60 value 520828.612116
iter  70 value 511272.480459
iter  80 value 505399.169176
iter  90 value 504210.861998
iter 100 value 504171.076545
iter 110 value 504167.970371
iter 120 value 504167.510171
final  value 504167.490166 
converged
# weights:  98 (78 variable)
initial  value 748467.096091 
iter  10 value 582511.589203
iter  20 value 567340.012597
iter  30 value 553488.233716
iter  40 value 537655.594760
iter  50 value 534824.876335
iter  60 value 525502.198924
iter  70 value 512996.713239
iter  80 value 506475.015847
iter  90 value 504965.487881
iter 100 value 504938.379836
final  value 504937.826673 
converged
# weights:  98 (78 variable)
initial  value 747873.593495 
iter  10 value 581271.333157
iter  20 value 565846.033579
iter  30 value 553897.370602
iter  40 value 536428.400172
iter  50 value 533324.447646
iter  60 value 519623.381518
iter  70 value 510091.467079
iter  80 value 505678.094433
iter  90 value 504541.138811
iter 100 value 504525.471455
final  value 504525.424807 
converged
# weights:  98 (78 variable)
initial  value 748525.473395 
iter  10 value 584430.991679
iter  20 value 569735.869879
iter  30 value 558267.533816
iter  40 value 545227.965954
iter  50 value 542097.115990
iter  60 value 534837.983927
iter  70 value 514739.234466
iter  80 value 507703.178044
iter  90 value 505555.625847
iter 100 value 505532.168333
final  value 505532.108496 
converged
# weights:  98 (78 variable)
initial  value 749165.677834 
iter  10 value 586127.439746
iter  20 value 569455.903919
iter  30 value 555673.870004
iter  40 value 537108.662513
iter  50 value 535388.738604
iter  60 value 525520.820192
iter  70 value 510458.157722
iter  80 value 505818.284259
iter  90 value 505018.434102
iter 100 value 505008.890377
final  value 505008.882666 
converged
# weights:  98 (78 variable)
initial  value 750086.093335 
iter  10 value 585080.586820
iter  20 value 570595.228537
iter  30 value 555605.385864
iter  40 value 543202.950882
iter  50 value 541039.078280
iter  60 value 527670.700071
iter  70 value 516882.317084
iter  80 value 510327.264273
iter  90 value 507410.311047
iter 100 value 507383.469803
iter 110 value 507382.051725
final  value 507381.972455 
converged
# weights:  98 (78 variable)
initial  value 749346.647478 
iter  10 value 586291.599094
iter  20 value 571463.633794
iter  30 value 555251.569408
iter  40 value 540714.413545
iter  50 value 538208.068421
iter  60 value 524922.778076
iter  70 value 511749.141809
iter  80 value 506515.736547
iter  90 value 505678.465320
iter 100 value 505662.467396
final  value 505662.424972 
converged
# weights:  98 (78 variable)
initial  value 749852.584117 
iter  10 value 585091.048570
iter  20 value 570487.939148
iter  30 value 554224.337618
iter  40 value 545207.608450
iter  50 value 542998.382583
iter  60 value 523574.947287
iter  70 value 512352.949701
iter  80 value 507690.704984
iter  90 value 506457.363312
iter 100 value 506441.642486
final  value 506441.579198 
converged
# weights:  98 (78 variable)
initial  value 745867.360132 
iter  10 value 581916.027979
iter  20 value 566655.115894
iter  30 value 554775.921190
iter  40 value 536693.143905
iter  50 value 534378.950264
iter  60 value 527881.563685
iter  70 value 513033.555210
iter  80 value 505528.391065
iter  90 value 504279.763183
iter 100 value 504257.414205
final  value 504257.309441 
converged
# weights:  98 (78 variable)
initial  value 746513.402301 
iter  10 value 585896.386604
iter  20 value 571358.916426
iter  30 value 556119.424347
iter  40 value 541842.753103
iter  50 value 539199.324648
iter  60 value 521593.725464
iter  70 value 510590.617369
iter  80 value 504547.807280
iter  90 value 503510.806223
iter 100 value 503498.307119
final  value 503498.009677 
converged
# weights:  98 (78 variable)
initial  value 745884.873323 
iter  10 value 582559.463464
iter  20 value 567597.676369
iter  30 value 553086.905300
iter  40 value 539643.354316
iter  50 value 537190.694757
iter  60 value 530614.346149
iter  70 value 516141.509588
iter  80 value 506361.234224
iter  90 value 503662.111159
iter 100 value 503639.873014
final  value 503639.857722 
converged</code></pre>
</div>
</div>
<p>We can then generate the calibration summary as before, with the caveat we need to do this for each outcome probability. Since the above code returns a dataset with a column for each outcome separately, we need to <strong>pivot</strong> the dataset from wide to long so that there is a row for each play-outcome combination. We can do this using the useful <code>pivot_longer()</code> function as shown below, with the same summary steps as before:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ep_cv_loso_calibration_results <span class="ot">&lt;-</span> init_loso_cv_preds <span class="sc">|&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># First specify which columns to turn into rows</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(No_Score<span class="sc">:</span>Touchdown,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>               <span class="co"># Name of the column for the outcomes</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"next_score_type"</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>               <span class="co"># Name of the column for the predicted probabilities</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"pred_prob"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># And then the same steps as before but now with grouping by score outcome:</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bin_pred_prob =</span> <span class="fu">round</span>(pred_prob <span class="sc">/</span> <span class="fl">0.05</span>) <span class="sc">*</span> .<span class="dv">05</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(next_score_type, bin_pred_prob) <span class="sc">|&gt;</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n_plays =</span> <span class="fu">n</span>(), </span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">n_scoring_event =</span> <span class="fu">length</span>(<span class="fu">which</span>(Next_Score_Half <span class="sc">==</span> next_score_type)),</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">bin_actual_prob =</span> n_scoring_event <span class="sc">/</span> n_plays,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">bin_se =</span> <span class="fu">sqrt</span>((bin_actual_prob <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> bin_actual_prob)) <span class="sc">/</span> n_plays),</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bin_upper =</span> <span class="fu">pmin</span>(bin_actual_prob <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> bin_se, <span class="dv">1</span>),</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">bin_lower =</span> <span class="fu">pmax</span>(bin_actual_prob <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> bin_se, <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then with this dataset we can create calibration plots for each outcome, using similar code as before:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>ep_cv_loso_calibration_results <span class="sc">|&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">next_score_type =</span> <span class="fu">fct_relevel</span>(next_score_type,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Opp_Safety"</span>, <span class="st">"Opp_Field_Goal"</span>, </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Opp_Touchdown"</span>, <span class="st">"No_Score"</span>, <span class="st">"Safety"</span>, </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">"Field_Goal"</span>, <span class="st">"Touchdown"</span>),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">next_score_type =</span> <span class="fu">fct_recode</span>(next_score_type, </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"-Field Goal (-3)"</span> <span class="ot">=</span> <span class="st">"Opp_Field_Goal"</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"-Safety (-2)"</span> <span class="ot">=</span> <span class="st">"Opp_Safety"</span>, </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"-Touchdown (-7)"</span> <span class="ot">=</span> <span class="st">"Opp_Touchdown"</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Field Goal (3)"</span> <span class="ot">=</span> <span class="st">"Field_Goal"</span>, </span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"No Score (0)"</span> <span class="ot">=</span> <span class="st">"No_Score"</span>,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Touchdown (7)"</span> <span class="ot">=</span> <span class="st">"Touchdown"</span>, </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>                               <span class="st">"Safety (2)"</span> <span class="ot">=</span> <span class="st">"Safety"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> bin_pred_prob, <span class="at">y =</span> bin_actual_prob)) <span class="sc">+</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> bin_lower, <span class="at">ymax =</span> bin_upper)) <span class="sc">+</span> </span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_equal</span>() <span class="sc">+</span>   </span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Estimated next score probability"</span>, </span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Observed next score probability"</span>) <span class="sc">+</span> </span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span> </span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.background =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>)) <span class="sc">+</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> next_score_type, <span class="at">ncol =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="03-multinom-logit_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><em>What stands out for you when inspecting the different calibration plots?</em></p>
</section>
<section id="recap" class="level2">
<h2 class="anchored" data-anchor-id="recap">Recap</h2>
<ul>
<li><p>Introduced fitting and interpreting a multinomial logistic regression model</p></li>
<li><p>Walked through steps for performing cross-validation calibration for multiple outcomes</p></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/ryurko\.github\.io\/cmu-sportsanalytics-spring25\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>